<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Http\Resources\VulnerabilityScoreResource;
use App\Models\VulnerabilityScore;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\Request;

class VulnerabilityScoreController extends Controller
{
    public function index(): JsonResponse
    {
        $scores = VulnerabilityScore::with(['user', 'assessor'])
            ->orderBy('overall_score', 'desc')
            ->get();
        return response()->json(VulnerabilityScoreResource::collection($scores));
    }

    public function show(VulnerabilityScore $vulnerabilityScore): JsonResponse
    {
        $vulnerabilityScore->load(['user', 'assessor']);
        return response()->json(new VulnerabilityScoreResource($vulnerabilityScore));
    }

    public function store(Request $request): JsonResponse
    {
        $validated = $request->validate([
            'user_id' => 'required|exists:users,id',
            'economic_score' => 'required|numeric|min:0|max:100',
            'social_score' => 'required|numeric|min:0|max:100',
            'health_score' => 'required|numeric|min:0|max:100',
            'geographic_score' => 'required|numeric|min:0|max:100',
            'score_breakdown' => 'nullable|array',
            'assessment_date' => 'required|date',
            'assessed_by' => 'nullable|exists:users,id',
            'notes' => 'nullable|string',
        ]);

        // Calculate overall score
        $overallScore = (
            ($validated['economic_score'] * 0.30) +
            ($validated['social_score'] * 0.25) +
            ($validated['health_score'] * 0.25) +
            ($validated['geographic_score'] * 0.20)
        );
        $validated['overall_score'] = $overallScore;

        $score = VulnerabilityScore::create($validated);
        $score->load(['user', 'assessor']);
        return response()->json(new VulnerabilityScoreResource($score), 201);
    }

    public function update(Request $request, VulnerabilityScore $vulnerabilityScore): JsonResponse
    {
        $validated = $request->validate([
            'economic_score' => 'sometimes|numeric|min:0|max:100',
            'social_score' => 'sometimes|numeric|min:0|max:100',
            'health_score' => 'sometimes|numeric|min:0|max:100',
            'geographic_score' => 'sometimes|numeric|min:0|max:100',
            'score_breakdown' => 'nullable|array',
            'assessment_date' => 'sometimes|date',
            'assessed_by' => 'nullable|exists:users,id',
            'notes' => 'nullable|string',
        ]);

        // Recalculate overall score if any score changed
        if (isset($validated['economic_score']) || isset($validated['social_score']) || 
            isset($validated['health_score']) || isset($validated['geographic_score'])) {
            $economic = $validated['economic_score'] ?? $vulnerabilityScore->economic_score;
            $social = $validated['social_score'] ?? $vulnerabilityScore->social_score;
            $health = $validated['health_score'] ?? $vulnerabilityScore->health_score;
            $geographic = $validated['geographic_score'] ?? $vulnerabilityScore->geographic_score;
            
            $validated['overall_score'] = (
                ($economic * 0.30) +
                ($social * 0.25) +
                ($health * 0.25) +
                ($geographic * 0.20)
            );
        }

        $vulnerabilityScore->update($validated);
        $vulnerabilityScore->load(['user', 'assessor']);
        return response()->json(new VulnerabilityScoreResource($vulnerabilityScore));
    }

    public function getByUser($userId): JsonResponse
    {
        $score = VulnerabilityScore::where('user_id', $userId)
            ->with(['user', 'assessor'])
            ->first();
        
        if (!$score) {
            return response()->json(['message' => 'Vulnerability score not found'], 404);
        }
        
        return response()->json(new VulnerabilityScoreResource($score));
    }

    public function getPriorityList(): JsonResponse
    {
        $scores = VulnerabilityScore::with(['user'])
            ->orderBy('overall_score', 'desc')
            ->get();
        return response()->json(VulnerabilityScoreResource::collection($scores));
    }
}
