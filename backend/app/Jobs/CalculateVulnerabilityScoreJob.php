<?php

namespace App\Jobs;

use App\Models\Request;
use App\Models\User;
use App\Models\VulnerabilityScore;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;

class CalculateVulnerabilityScoreJob implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    protected $userId;

    public function __construct($userId)
    {
        $this->userId = $userId;
    }

    public function handle(): void
    {
        $user = User::find($this->userId);
        
        if (!$user || $user->role !== 'requestor') {
            return;
        }

        // Calculate vulnerability score based on user's requests and profile
        // This is a simplified calculation - adjust based on your business logic
        $requests = Request::where('user_id', $this->userId)->get();
        
        // Calculate scores based on request urgency and frequency
        $economicScore = $this->calculateEconomicScore($user, $requests);
        $socialScore = $this->calculateSocialScore($user, $requests);
        $healthScore = $this->calculateHealthScore($user, $requests);
        $geographicScore = $this->calculateGeographicScore($user, $requests);
        
        $overallScore = ($economicScore + $socialScore + $healthScore + $geographicScore) / 4;
        
        $priorityLevel = $this->getPriorityLevel($overallScore);

        VulnerabilityScore::updateOrCreate(
            ['user_id' => $this->userId],
            [
                'economic_score' => $economicScore,
                'social_score' => $socialScore,
                'health_score' => $healthScore,
                'geographic_score' => $geographicScore,
                'overall_score' => $overallScore,
                'priority_level' => $priorityLevel,
                'assessment_date' => now(),
            ]
        );
    }

    protected function calculateEconomicScore($user, $requests): float
    {
        // Simplified: Based on number of urgent requests
        $urgentCount = $requests->where('urgency_level', 'critical')->count();
        return min(10, 5 + ($urgentCount * 1.5));
    }

    protected function calculateSocialScore($user, $requests): float
    {
        // Simplified: Based on recipient type
        $disasterZone = $requests->where('recipient_type', 'disaster_zone')->count();
        $refugeeCamp = $requests->where('recipient_type', 'refugee_camp')->count();
        return min(10, 3 + ($disasterZone * 2) + ($refugeeCamp * 1.5));
    }

    protected function calculateHealthScore($user, $requests): float
    {
        // Simplified: Based on medical needs
        $medicalNeeds = $requests->where('need_type', 'medical_emergency')->count();
        return min(10, 4 + ($medicalNeeds * 2));
    }

    protected function calculateGeographicScore($user, $requests): float
    {
        // Simplified: Based on remote locations
        $remoteLocations = $requests->where('recipient_type', 'remote_village')->count();
        return min(10, 3 + ($remoteLocations * 1.5));
    }

    protected function getPriorityLevel($score): string
    {
        if ($score >= 8.0) return 'Critical';
        if ($score >= 6.0) return 'High';
        if ($score >= 4.0) return 'Medium';
        return 'Low';
    }
}
