<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class VulnerabilityScore extends Model
{
    use HasFactory;

    protected $fillable = [
        'user_id',
        'economic_score',
        'social_score',
        'health_score',
        'geographic_score',
        'overall_score',
        'score_breakdown',
        'assessment_date',
        'assessed_by',
        'notes',
    ];

    protected $casts = [
        'economic_score' => 'decimal:2',
        'social_score' => 'decimal:2',
        'health_score' => 'decimal:2',
        'geographic_score' => 'decimal:2',
        'overall_score' => 'decimal:2',
        'score_breakdown' => 'array',
        'assessment_date' => 'date',
    ];

    public function user()
    {
        return $this->belongsTo(User::class);
    }

    public function assessor()
    {
        return $this->belongsTo(User::class, 'assessed_by');
    }

    public function calculateOverallScore(): float
    {
        // Weighted average: Economic 30%, Social 25%, Health 25%, Geographic 20%
        return (
            ($this->economic_score * 0.30) +
            ($this->social_score * 0.25) +
            ($this->health_score * 0.25) +
            ($this->geographic_score * 0.20)
        );
    }

    public function getPriorityLevelAttribute(): string
    {
        if ($this->overall_score >= 80) {
            return 'Critical';
        } elseif ($this->overall_score >= 60) {
            return 'High';
        } elseif ($this->overall_score >= 40) {
            return 'Medium';
        } else {
            return 'Low';
        }
    }
}
